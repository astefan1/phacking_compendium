# ==============================================================================
# Exploiting arbitrary cutoff values
# ==============================================================================

# Simulation can be done with .sim.multcor where the correlation is zero

#' P-Hacking function for exploiting cutoff values
#' @param df Data frame with one continuous independent variable and one continuous dependent variable
#' @param iv Location of the independent variable in the data frame
#' @param dv Location of the dependent variable in the data frame
#' @param strategy String value: One out of "firstsig", "smallest", "smallest.sig"
#' @param alpha Significance level of the t-test
#' @importFrom stats t.test aov median quantile

.cutoffHack <- function(df, iv, dv, strategy = "firstsig", alpha = 0.05){

  iv <- df[, iv]
  dv <- df[, dv]

  p.orig <- summary(stats::lm(dv ~ iv))$coefficients[2, 4]

  # Do the mediansplit
  mediansplitvar <- as.numeric(iv > stats::median(iv)) + 1
  p.mediansplit <- stats::t.test(dv[mediansplitvar == 1], dv[mediansplitvar == 2],
                          var.equal = TRUE, alternative = "two.sided")$p.value

  # Cut the middle
  tertiles <- as.numeric(stats::quantile(iv, probs = c(1/3, 2/3)))
  threecut <- cut(iv, breaks = c(-Inf, tertiles, Inf), labels = c(1,0,2))
  dv2 <- dv[threecut %in% c(1,2)]
  threecut2 <- threecut[threecut %in% c(1, 2)]
  p.cutmiddle <- stats::t.test(dv2[threecut2 == 2], dv2[threecut2 == 1],
                        var.equal = TRUE, alternative = "two.sided")$p.value

  # 3 Categories: Omnibus test
  p.threecat <- summary(stats::aov(dv ~ threecut))[[1]][[5]][1]

  ps <- c(p.orig, p.mediansplit, p.cutmiddle, p.threecat)

  # Select final p-hacked p-value based on strategy
  p.final <- .selectpvalue(ps = ps, strategy = strategy, alpha = alpha)

  return(list(p.final = p.final,
              ps = ps))

}

#' Simulate p-Hacking for exploiting cutoff values
#' Outputs a matrix containing the p-hacked p-values (\code{ps.hack}) and the original p-values (\code{ps.orig}) from all iterations
#' @param nobs Number of observations
#' @param strategy String value: One out of "firstsig", "smallest", "smallest.sig"
#' @param alpha Significance level of the t-test
#' @param iter Number of simulation iterations
#' @param seed Initial seed for the random process
#' @export

sim.cutoffHack <- function(nobs, strategy = "firstsig", alpha = 0.05, iter = 1000, seed = 1234){

  dat <- list()
  set.seed(seed)
  for(i in 1:iter){
    dat[[i]] <- .sim.multcor(nobs = nobs, nvar = 2, r = 0)
  }

  # Apply p-hacking procedure to each dataset
  .cutoffHackList <- function(x){
    .cutoffHack(df = x, iv = 1, dv = 2, strategy = strategy, alpha = alpha)
  }

  res <- lapply(dat, .cutoffHackList)

  ps.hack <- NULL
  ps.orig <- NULL
  for(i in 1:iter){
    ps.hack[i] <- res[[i]][["p.final"]]
    ps.orig[i] <- res[[i]][["ps"]][1]
  }

  res <- cbind(ps.hack, ps.orig)

  return(res)



}
